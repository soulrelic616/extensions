define(function(require,t,n){"use strict";function Ge(e){e.preventDefault(),e.stopImmediatePropagation()}function Ue(e,t){T.set(e,t),T.save()}function Xe(e){y.open(e);var t=a.setTimeout(function(){y.isOpen()||Xe(e),a.clearTimeout(t)},180)}function Ke(e,t,n){C.setFileViewFocus(C.WORKING_SET_VIEW),h.execute(m.FILE_OPEN,{fullPath:e,paneId:t}).always(function(){g.focusActivePane()}).done(n)}function Ye(e,t,n,a){var i=g.getCurrentlyViewedFile(t);return!i&&n?void Ke(n.fullPath,t,function(){a&&Xe(e)}):void((a||i.id!==n.id)&&(i.id===n.id&&a?Xe(e):Ke(n.fullPath,t,function(){a&&Xe(e)})))}function Ze(e,t){h.execute(m.FILE_CLOSE,{file:e,paneId:t}).always(function(){g.focusActivePane()})}function qe(e,t,n){var i=t===F?N:F,o=g._getPane(i);if(!o.getViewForPath(e.fullPath)){var r=n||g.getActivePaneId(),s=o.findInViewList(e.fullPath);-1!==s&&h.execute(m.FILE_CLOSE,{File:e,paneId:t}),g._moveView(t,i,e).always(function(){h.execute(m.FILE_OPEN,{fullPath:e.fullPath,paneId:i}).always(function(){var e=g._getPane(t),n=r===t?e:o;e.trigger("viewListChange"),o.trigger("viewListChange"),a.setTimeout(function(){n.focus(),e._lastFocusedElement=n.$el[0],g.setActivePaneId(r)},1)})})}}function Qe(e,t,n,a){g._moveView(t,a,e,n).always(function(){h.execute(m.FILE_OPEN,{fullPath:e.fullPath,paneId:a}).always(function(){g.focusActivePane(),l.refresh(!0)})})}function et(e,t,n){g._moveWorkingSetItem(t,e,n),g.focusActivePane()}function tt(e,t){var a,n=0;for(a=0;a<e.length;a+=1){if(e[a]===t)return n;1===e[a].nodeType&&(n+=1)}return-1}function nt(){Be.removeClass("cw-sortable-dragging").addClass("cw-dragged-index"),ze&&ze.length&&(ze.is(":visible")||ze.show()),He&&(He=!1,Je.remove()),Ve&&(Ve=!1,je.remove())}function at(e,t,n){t!==n?et(t,e,n):nt()}function it(e,t,n,a,i){if(e!==t){var o=g.findInWorkingSet(t,i.fullPath);o>-1&&(Oe=!0,e=t,n=o)}var r=0;if(a){var s=a.getElementsByClassName("cw-dragged-index"),l=a.getElementsByClassName("cw-sortable-placeholder")[0];l?r=tt(s,l):(r=0,_e=!0)}else r=n;if(e!==t)Qe(i,e,r,t);else{if(Oe)return Oe=!1,_e?(_e=!1,void nt()):void at(e,n,r);at(e,n,r)}}function ot(e){if(!Te){if("dragover"===e.type)return e.originalEvent.dataTransfer.dropEffect="move",!1;if("dragenter"===e.type){if("LI"===e.target.tagName){var t=Re;Re=e.currentTarget.id;var n=$("#"+Re);De||(Ae=e.currentTarget,De=Ae.attributes["data-paneid"].value);var a=$(e.target);if(a[0]!==Je[0]&&(ze=$(".cw-dragli-"+Fe.id,n),ze.length&&ze.is(":visible")&&ze.removeClass("cw-dragged-index").hide(),n.find(je).length||(je.data(A,0).prependTo(n),Ve=!0),a.after(Je),He=!0,t&&Re&&t!==Re)){var i=$(".cw-dragli-"+Fe.id,$("#"+t));i.is(":visible")||i.addClass("cw-dragged-index").show()}}return e.stopPropagation(),e.preventDefault(),!1}"UL"===e.currentTarget.tagName&&(Le=!1,Ae=e.currentTarget,De=Ae.attributes["data-paneid"].value,it(Ne,De,xe,Ae,Fe))}}function rt(e){var t=e.getBoundingClientRect();return t.top>=0&&t.left>=0&&t.bottom<=(a.innerHeight||i.documentElement.clientHeight)&&t.right<=(a.innerWidth||i.documentElement.clientWidth)}function st(e,t,n){var a=g.getCurrentlyViewedFile(e);if(a){var i=g.findInWorkingSet(e,a.fullPath);if(!(0>i)&&n[0].scrollWidth>t.width()){var r,o=function(e){if(e=e[0],!rt(e)){var a=e.offsetLeft,i=n[0].scrollWidth-t.width(),o=a>i?i:a;n.data("scrollwheel",o),n.stop().animate({scrollLeft:o},300)}},s=$(".cw-dragli-"+a.id,n);s.length?(clearInterval(r),o(s)):r=setInterval(function(){s=$(".cw-dragli-"+a.id,n),s.length&&(clearInterval(r),o(s))},10)}}}function lt(e){return Me.getElementsByClassName(e)[0]}function ct(e){lt("cw-parentPath").innerHTML=e.parentPath,p.getDocumentForPath(e.fullPath).done(function(t){lt("cw-date").innerHTML=t.diskTimestamp;var n=t?t.isDirty:!1;e.stat(function(e,t){e?lt("cw-size").innerHTML="...":lt("cw-size").innerHTML=(n?"&#177;":"")+s.prettyPrintBytes(t.size.valueOf())});var a=t.getText();lt("cw-chars").innerHTML=a.length,lt("cw-lines").innerHTML=s.getLines(a).length,lt("cw-le").innerHTML=b.sniffLineEndings(a)||t._lineEndings,lt("cw-language").innerHTML=t.language.getId(),lt("cw-hash").innerHTML=t.diskTimestamp.valueOf()}),lt("cw-id").innerHTML=e.id}function ft(e){$("#cw-arrow").css("left",e.clientX-Me.offsetLeft)}function dt(e,t,n,i,o){var d,r=e-t/2,s=i+o,l=a.outerWidth,c=a.outerHeight,f=t>l||0>r?1:r>l-t?l-t-1:r;return n>s||c>s+n?(d=s,Me.className="cw-tabbar-tooltip cw-arrow-bottom"):(d=i-n+6,Me.className="cw-tabbar-tooltip cw-arrow-top"),{top:d,left:f}}function ut(e,t,n,i){if(ie)if(re)se&&(Me.style.display="none",le=!1,oe=0,se=!1);else if(e=a.event||e,oe+=1,oe>2&&(le&&ft(e),!se)){se=!0,ct(n),le=!0,Me.style.display="block";var o=$("#cw-"+t+"-tabbar"),r=o.outerHeight(),s=o.offset().top,l=Me.getBoundingClientRect().width||Me.offsetWidth,c=Me.getBoundingClientRect().height||Me.offsetHeight,f=dt(e.pageX,l,c,s,r),d=dt(e.pageX,Me.getBoundingClientRect().width,Me.getBoundingClientRect().height,s,r);if(Me.style.top=d.top+"px",Me.style.left=d.left+"px",i)return f}}function gt(){a.setTimeout(function(){if(_.hasClass("cw-force-display")&&!L.hasClass("cw-sidebar")){if(W.isOpen()||y.isOpen()||$("#project-dropdown").is(":visible")||$(".jstree-rename-input",_).length||$(".open-files-container.wsv-drag-ghost").length)return;_.css("z-index",ue),_.removeClass("cw-force-display"),L.addClass("cw-sidebar"),ue=void 0}},55)}function pt(e){return $(i.createElement("div")).addClass("cw-flipview-content"+(e?" cw-height":"")).hide().mousedown(function(e){e.stopPropagation()})}function wt(e,t){return $(i.createElement("div")).addClass("cw-icon-cw cw-close-file cw-height").mousedown(function(e){e.preventDefault()}).attr("title",o.CMD_FILE_CLOSE).click(function(n){Ze(e,t),$(a).trigger("CustomWorkScroll"),n.stopPropagation()})}function mt(e){return $(i.createElement("div")).addClass("cw-icon-cw cw-file-rename").attr("title",o.CMD_FILE_RENAME).click(function(t){var n=$(this).parent().parent();n.removeAttr("draggable"),n.append(function(){return $(i.createElement("div")).addClass("cw-actions-boxrename").append(function(){return $(i.createElement("input")).attr({value:e.name,"class":"cw-actions-rename"}).on("change",function(){var t=$(this).next(),n=e.parentPath+$(this).val();e.rename(n,function(e){e&&t.addClass("cw-needcancel").attr("title",r.NOT_READABLE)})})}).append(function(){return $(i.createElement("div")).attr({"class":"cw-icon-cw cw-close-file cw-actions-cancelrename",title:o.CANCEL}).on("click",function(e){var t=$(this).parent();t.next().remove(),t.remove(),n.attr("draggable",!0),e.stopPropagation()})}).on("click",function(e){e.stopPropagation()})}).append(function(){return $(i.createElement("div")).addClass("cw-actions-minspace")}),t.stopPropagation()})}function ht(e){return $(i.createElement("div")).addClass("cw-icon-cw cw-showinos-file").attr("title",o.CMD_SHOW_IN_EXPLORER).click(function(t){brackets.app.showOSFolder(e.fullPath,function(t){t&&console.error("Error showing '"+e.fullPath+"' in OS folder:",t)}),t.stopPropagation()})}function vt(e){return $(i.createElement("div")).addClass("cw-icon-cw cw-icon-trash").attr("title",o.DELETE).click(function(t){c.deleteItem(e),t.stopPropagation()})}function Ct(e){return"InMemoryFile"===e.constructor.name}function bt(e,t){var n=$(i.createElement("div")).addClass("cw-file-actions");return Ct(e)?n.append(wt(e,t)):n.append(ht(e,t)).append(mt(e,t)).append(vt(e,t)).append(wt(e,t)),n}function kt(e,t,n,i){var o=g.setLayoutScheme(e,t);o&&a.setTimeout(function(){qe(n,i,N)},1)}function It(e,t,n,i,o){var r=n===F?N:F;if(e){var s=g.setLayoutScheme(i,o);s&&a.setTimeout(function(){Ke(t,r)},1)}else Ke(t,r)}function Et(e,t,n,a,r,l){if(!(t&&(a.addClass("cw-li-bg"),a.outerWidth()<=47))&&(a.addClass("cw-btns"),!t||n)){var c=g.getPaneCount(),f={"first-pane":[o.BOTTOM,o.RIGHT],"second-pane":[o.TOP,o.LEFT]},d=o.FLIPVIEW_BTN_TOOLTIP||"Flip this view to {0} pane";if(2>c)r.removeAttr("title"),r.removeClass("cw-icon-cw "+ne[e].join(" ")),r.append($(i.createElement("div")).addClass("cw-icon-cw cw-flipview-btn "+ne[e][1]).attr("title",s.format(d,f[e][1])).on("click",function(t){2===t.which?(It(!0,l.fullPath,e,1,2),t.preventDefault()):kt(1,2,l,e),t.stopPropagation()})),r.append($(i.createElement("div")).addClass("cw-icon-cw cw-flipview-btn "+ne[e][0]).attr("title",s.format(d,f[e][0])).on("click",function(t){2===t.which?(It(!0,l.fullPath,e,2,1),t.preventDefault()):kt(2,1,l,e),t.stopPropagation()}));else{r.removeClass(ne[e].join(" "));var u=g.getLayoutScheme();r.addClass("cw-icon-cw "+ne[e][u.columns-1]).attr("title",s.format(f[e][u.columns-1])).on("click",function(t){2===t.which?(It(!1,l.fullPath,e),t.preventDefault()):qe(l,e),t.stopPropagation()})}r.show()}}function $t(e,t,n,a,o){var r=t.data(D),s=t.attr("class")||"",l="cw-dragged-index,"+(s?s+",":"")+"cw-dragli-"+r.id,c=pt(a),f=$(i.createElement("li")).mousedown(function(t){t.stopPropagation(),re=!0,2===t.which&&(t.preventDefault(),Ze(r,e))}).mouseup(function(){re=!1}).click(function(t){1===t.which&&(t.preventDefault(),Ye(t,e,r))}).contextmenu(function(t){t.preventDefault(),3===t.which&&Ye(t,e,r,!0)}).on("mouseenter",function(){Et(e,a,o,$(this),c,r)}).on("mouseleave",function(){a||c.hide().empty(),a&&($(this).removeClass("cw-li-bg"),o&&c.hide().empty()),$(this).removeClass("cw-btns"),a&&ie&&se&&(Me.style.display="none",le=!1,oe=0,se=!1)}).on("mousemove",function(t){a&&ut(t,e,r)}).data(A,n+1).on("dragstart",function(t){Te=!1;var a=$(this);Ne=e,xe=n,Fe=r,Be=a.removeClass("cw-dragged-index").addClass("cw-sortable-dragging"),t.originalEvent.dataTransfer.setData("text/plain",r.fullPath),t.originalEvent.dataTransfer.effectAllowed="move",Je.html(a.html()),g.getPaneCount()>1&&$(".horz-resizer").addClass("cw-zIndex-minus")}).on("dragend",function(){re=!1,Te||(Te=!0,He&&Ve&&Le&&it(Ne,De,xe,Ae,Fe),Ne=void 0,xe=void 0,Fe=void 0,De=void 0,Ae=void 0,Re=void 0,Be=void 0,ze=void 0,Le=!0,g.getPaneCount()>1&&$(".horz-resizer").removeClass("cw-zIndex-minus"))}).attr("draggable",!0).append(t.html());return a?(o&&f.append(c),f.append(wt(r,e)),l+=",cw-height",f.attr({title:r.name})):(f.append(c),f.append(bt(r,e))),f.addClass(l.replace(/,/g," ")),f}function Pt(e,t,n,a){if(t.hasClass("cw-close-tabmenu")){n.removeClass("cw-close-tabmenu"),n.attr("title","Hide Tab Menu");var i=g.getWorkingSetSize(e),r=2===i?o.FIND_IN_FILES_FILE:o.FIND_IN_FILES_FILES;$(".cw-tabmenu-files-length",t).html(i+" "+r),a.empty(),$("ul > li",$("#working-set-list-"+e+" .open-files-container")).each(function(t){a.append($t(e,$(this),t,!1))}),t.removeClass("cw-close-tabmenu")}else n.addClass("cw-close-tabmenu"),n.attr("title","Show Tab Menu"),t.addClass("cw-close-tabmenu")}function St(e){h.execute(m.FILE_CLOSE_LIST,{fileList:g.getWorkingSet(e)}),e===N&&M.get("pane.mergePanesWhenLastFileClosed")&&g.setLayoutScheme(1,1)}function Wt(e,t,n){var i=g._getPane(n);g._getPane(t).removeViews(e),i.addListToViewList(e),l.refresh(!0),a.setTimeout(function(){g.setActivePaneId(n),i.focus()},3)}function yt(e){var t=g.getWorkingSet(e),n=e===F?N:F,a=g.getPaneCount(),i=g.getCurrentlyViewedFile(e);if(a>1){var o=g.getCurrentlyViewedFile(n);Wt(t,e,n),!o&&i&&h.execute(m.FILE_OPEN,{fullPath:i.fullPath,paneId:n})}else{var r=g.setLayoutScheme(2,1);r&&(Wt(t,e,n),i&&h.execute(m.FILE_OPEN,{fullPath:i.fullPath,paneId:n}))}}function Mt(e){if(e.preventDefault(),e=a.event||e,e.ctrlKey)return void(e.wheelDelta>=0?h.execute(m.NAVIGATE_PREV_DOC_LIST_ORDER):h.execute(m.NAVIGATE_NEXT_DOC_LIST_ORDER));if(ce){var t=$(e.currentTarget);if(t.children().length&&t[0].scrollWidth>t.parent().width()){var n=Math.max(-1,Math.min(1,e.wheelDelta||-e.detail)),i=t.data("scrollwheel"),o=0>n?de+i:i-de,r=t[0].scrollWidth-t.parent().width(),s=o>r?r:0>o?0:o;t.data("scrollwheel",s),t.scrollLeft(t.data("scrollwheel"))}}}function Tt(e,t){a.localStorage.setItem(e,t)}function Lt(e,t){t.splice(0,2);var n,a=t.length;for(n=0;a>n;n+=1)e.removeLineClass(t[n],"wrap","cw-bookmark")}function _t(e){$("#cwb-clear").addClass("cw-disabled"),e.addClass("not-editor")}function Ot(e){var t,n,a,i,o=!1;for(t in e)if(e.hasOwnProperty(t))for(n=e[t],i=n.length,a=0;i>a;a+=1)if("number"==typeof n[a])return!0;return o}function xt(){var l,e=brackets.getModule("filesystem/FileSystem"),t=$("#cwb-body"),n=JSON.parse(a.localStorage.getItem(Y))||{},o=function(e,n){var o=n[1];return n.splice(0,2),$(i.createElement("li")).attr({"class":"cwb-items",title:e}).on("click",function(t){t.preventDefault(),Ke(e,g.ACTIVE_PANE)}).html('<span class="cwb-name">'+o+'</span><span class="cwb-lines">'+n.join(" ")+"</span>").append(function(){return $(i.createElement("span")).addClass("cwb-close").on("click",function(n){n.stopPropagation();var i=JSON.parse(a.localStorage.getItem(Y))||{},o=s.hashCode(e.replace(/\W/g,""));p.getDocumentForPath(e).done(function(e){e.hasOwnProperty("_masterEditor")&&(Lt(e._masterEditor._codeMirror,i[o]),$(e._masterEditor.getRootElement()).find(".cwb-bar").empty())}),delete i[o],Tt(Y,JSON.stringify(i)),1==t.find("li").length&&_t(t),$(this).parent().remove()}).html("x")})},r=function(n){var i=JSON.parse(a.localStorage.getItem(Y))||{},r=n[0];if(n&&void 0!==n[2]){var l=e.getFileForPath(r);l.hasOwnProperty("_stat")?t.append(o(r,n)):delete i[s.hashCode(r.replace(/\W/g,""))]}else delete i[s.hashCode(r.replace(/\W/g,""))];Tt(Y,JSON.stringify(i))},c=Ot(n);if(Ot(n)){c=void 0;for(l in n)if(n.hasOwnProperty(l)){var f=n[l];r(f)}$("#cwb-clear").on("click",function(e){e.preventDefault(),$(".cwb-bar").empty();var r,n=function(e){p.getDocumentForPath(e.fullPath).done(function(e){if(e.hasOwnProperty("_masterEditor")){var t=JSON.parse(a.localStorage.getItem(Y))||{},n=s.hashCode(e.file.fullPath.replace(/\W/g,"")),i=t[n];i&&Lt(e._masterEditor._codeMirror,i)}})},i=g.getWorkingSet(g.ALL_PANES),o=i.length;for(r=0;o>r;r+=1)n(i[r]);a.localStorage.removeItem(Y),t.html(""),$(this).addClass("cw-disabled")})}else _t(t)}function Ft(e,t,n){t!==n&&T.set(e,t)}function Nt(e,t){var n;for(n in G)if(G.hasOwnProperty(n)){var a=$("#"+n,e);if(t){var i=T.get(G[n]);a.prop(U[a.attr("type")],i),"CWs"==a.attr("id")?($("#CWss",e).parent().parent()[i?"removeClass":"addClass"]("cw-disabled"),$("#CWsc",e).parent().parent()[i?"removeClass":"addClass"]("cw-disabled")):"CWui"==a.attr("id")&&$("#CWgs",e).parent().parent()[i?"removeClass":"addClass"]("cw-disabled")}else{var o=a.prop(U[a.attr("type")]),r=typeof o;"boolean"!==r&&(o=~~o),Ft(G[n],o,T.get(G[n]))}}}function Dt(){if(T.get(G.CWah)){var e=function(){var t=g.getActivePaneId(),n=$("#cw-"+t+"-tabmenu"),a=$("#cw-"+t+"-listview"),o=n.hasClass("cw-close-tabmenu");o||(n.addClass("cw-close-tabmenu"),a.addClass("cw-close-tabmenu")),$(i.body).off("click",e)};$(i.body).on("click",e)}}function At(e,t,n,a){$("#"+t).prepend(s.format(e,t)),$("#cw-"+t+"-tabbar").on("contextmenu",Ge),$("#cw-"+t+"-nav-ul").on("drop dragover dragenter",ot).on("mousewheel",Mt);var r=$("#cw-"+t+"-tabmenu"),l=$("#cw-"+t+"-tabmenu-ul");$("#cw-"+t+"-listview").click(function(e){e.stopPropagation(),Pt(t,r,$(this),l),Dt()}),r.on("contextmenu",Ge),$("#cw-"+t+"-prefs").on("click",function(e){e.preventDefault(),ae()}),$("#cw-"+t+"-bookmarks").on("click",function(e){e.preventDefault(),$(i.body).append(a),xt()}),$("#cw-"+t+"-open").on("click",function(e){e.preventDefault(),h.execute(m.FILE_OPEN)}),$("#cw-"+t+"-move-list").on("click",function(e){e.preventDefault(),yt(t)}),$("#cw-"+t+"-close-all").on("click",function(e){e.preventDefault(),St(t)}),l.on("drop dragover dragenter",ot),$("#cw-"+t+"-hover-sidebar").mouseenter(function(e){e.preventDefault(),k.isVisible()||_.hasClass("cw-force-display")||(ue=_.css("z-index"),_.addClass("cw-force-display"),_.css("z-index",19),L.removeClass("cw-sidebar")),e.stopPropagation()}),n&&(x=$(".cw-sidebar-btn"),k.isVisible()?x.html("←").attr("title",o.CMD_HIDE_SIDEBAR).addClass("cw-show-sidebar"):x.html("→").attr("title",o.CMD_SHOW_SIDEBAR).removeClass("cw-show-sidebar"),x.click(function(){k.toggle()}))}function Rt(e,t){var n=g.getCurrentlyViewedFile(e);if(n){var a=g.findInWorkingSet(e,n.fullPath);if(!(0>a)){var i=$(".cw-dragli-"+n.id,t);i.width(""),i[0].clientWidth<61&&i.width(61)}}}function Vt(){ce||(null!=Ht&&clearTimeout(Ht),Ht=setTimeout(function(){ge&&(O.removeClass("cw-nonscrollf"),we[0].clientWidth<we[0].scrollWidth&&O.addClass("cw-nonscrollf"),Rt(F,we)),ke&&(O.removeClass("cw-nonscrolls"),Ee[0].clientWidth<Ee[0].scrollWidth&&O.addClass("cw-nonscrolls"),Rt(N,Ee))},250))}function Bt(e,t){brackets.nativeMenus||O.addClass("cw-nonativemenu"),At(e,F,!0,t),ge=!0,pe=$("#cw-first-pane-navbar"),we=$("#cw-first-pane-nav-ul"),me=$("#cw-first-pane-listview"),he=$("#cw-first-pane-tabmenu"),ve=$(".cw-tabmenu-files-length",he),Ce=$("#cw-first-pane-tabmenu-ul"),be=$("#working-set-list-first-pane .open-files-container");var n=!0;he.on("click",function(e){e.stopPropagation()}),T.definePreference(G.CWmt,"boolean",!1,{description:r.CWMT}).on("change",function(){T.get(G.CWmt)?(O.addClass("cw-toolbar-moved"),$("#main-toolbar").insertAfter("#project-files-container"),n=!1):n||(O.removeClass("cw-toolbar-moved"),$("#main-toolbar").insertAfter(".content"))}),g.on("paneCreate",function(){At(e,N),ke=!0,Ie=$("#cw-second-pane-navbar"),Ee=$("#cw-second-pane-nav-ul"),$e=$("#cw-second-pane-listview"),Pe=$("#cw-second-pane-tabmenu"),Se=$(".cw-tabmenu-files-length",Pe),We=$("#cw-second-pane-tabmenu-ul"),ye=$("#working-set-list-second-pane .open-files-container"),Pe.on("click",function(e){e.stopPropagation()})}),g.on("paneDestroy",function(){ke=!1,Ie=void 0,Ee=void 0,$e=void 0,Pe=void 0,Se=void 0,We=void 0,ye=void 0}),T.definePreference(G.CWs,"boolean",!1,{description:r.CWS}).on("change",function(){T.get(G.CWs)?(ce=!0,O.removeClass("cw-nonscrollf"),O.removeClass("cw-nonscrolls")):(ce=!1,Vt())}),T.definePreference(G.CWsb,"boolean",!1,{description:r.CWSB}).on("change",function(){$(a).trigger("triggerForCustomWork")});var s=function(e){if(T.get(G.CWui)){if(e.isFile){var o,r,t=e.fullPath,n=v.getLanguageForPath(t),a=n.getId(),s=function(e){var t,n=e.lastIndexOf(".");return t=n>0?e.substr(n+1):b.getBaseName(e)};return"unknown"===a?o="cwi-"+a+" cwi-"+s(t).toLowerCase():(r=v.getCompoundFileExtension(t),o="html"===r?"cwi-"+a+" cwi-html5":r?"cwi-"+a+" cwi-"+r:"cwi-"+a+" cwi-"+s(t)),$(i.createElement("span")).addClass("cwi "+o)}return $(i.createElement("span")).addClass("cwi cw-folder-btn")}};l.addIconProvider(s),f.addIconProvider(s),T.definePreference(G.CWui,"boolean",!1,{description:r.CWUI}).on("change",function(){c.rerenderTree(),l.refresh(!0),$(a).trigger("triggerForCustomWork")}),T.definePreference(G.CWbs,"boolean",!1,{description:r.CWBS}).on("change",function(){T.get(G.CWbs)?O.addClass("cw-blueish"):O.removeClass("cw-blueish")}),T.definePreference(G.CWgs,"boolean",!1,{description:r.CWGS}).on("change",function(){T.get(G.CWgs)?O.addClass("cw-grayscale-icons"):O.removeClass("cw-grayscale-icons")}),T.definePreference(G.CWro,"boolean",!1,{description:r.CWRO}).on("change",function(){T.get(G.CWro)?O.addClass("cw-opacity-pane"):O.removeClass("cw-opacity-pane")}),T.definePreference(G.CWwl,"boolean",!1,{description:r.CWWL}).on("change",function(){T.get(G.CWwl)?O.removeClass("cw-swlvols"):O.addClass("cw-swlvols")}),T.definePreference(G.CWsc,"boolean",!1,{description:r.CWSC}).on("change",function(){fe=T.get(G.CWsc)?!0:!1}),T.definePreference(G.CWgb,"boolean",!1,{description:r.CWGB}).on("change",function(){X=T.get(G.CWgb)?!0:!1,X?O.hasClass("cw-bookmarks")||(O.addClass("cw-bookmarks"),$(i.createElement("a")).attr("id","cw-bookmark").attr("title","Bookmarks").css("color","#ccc").attr("class","cw-bookmark-btn cw-icon-cw").on("click",function(e){$(this).css("color","#1e90ff"),$(i.body).append(t),xt()}).appendTo($("#main-toolbar .bottom-buttons"))):(O.removeClass("cw-bookmarks"),$("#cw-bookmark").remove())}),_.on("panelCollapsed",function(){x.html("→").attr("title",o.CMD_SHOW_SIDEBAR).removeClass("cw-show-sidebar"),k.isVisible()||L.addClass("cw-sidebar")}),_.on("panelExpanded",function(){x.html("←").attr("title",o.CMD_HIDE_SIDEBAR).addClass("cw-show-sidebar"),k.isVisible()&&L.removeClass("cw-sidebar")}),_.on("mouseleave",gt),L.on("click",gt)}function zt(e,t,n,a,r,s,l,c){var f=g.getWorkingSetSize(e),d=T.get(G.CWsb),u=s.hasClass("cw-close-tabmenu");if(f)n.empty(),a.addClass("cw-visible"),u||l.empty(),r.find("ul > li").each(function(t){var a=$(this);if(n.append($t(e,a,t,!0,d)),!u){l.append($t(e,a,t,!1));var i=1===f?o.FIND_IN_FILES_FILE:o.FIND_IN_FILES_FILES;c.html(f+" "+i)}});else{n.html(o.EMPTY_VIEW_HEADER);var p=$("#cw-"+e+"-close"),w=$(i.createElement("div")).attr({"class":"cw-icon-cw cw-close-pane cw-height",title:o.CMD_SPLITVIEW_NONE,id:"cw-"+e+"-close"}).click(function(){g.setLayoutScheme(1,1)});p.length||n.append(w),a.removeClass("cw-visible"),u||s.addClass("cw-close-tabmenu")}}function Jt(){ge&&zt(F,pe,we,me,be,he,Ce,ve),ke&&zt(N,Ie,Ee,$e,ye,Pe,We,Se)}function Ut(){jt?(jt=!1,Jt()):Gt||(Gt=setTimeout(function(){Gt=void 0,Jt()},150)),ie&&se&&(Me.style.display="none",le=!1,oe=0,se=!1)}function qt(){if(X){if(Yt){var e=$(".CodeMirror.CodeMirror-wrap").filter(":visible");e.each(function(e,t){if(e||(Xt=Kt,Kt=t.offsetHeight,Zt=Xt!==Kt?!0:!1),Zt){var n=$(t).find(".CodeMirror-scroll .CodeMirror-gutters")[0].offsetHeight,a=t.offsetHeight,i=$(t).find(".cw-tickmark");i.length&&i.each(function(e,t){var i=~~t.getAttribute("data-top");t.style.top=~~(i/n*a)+"px"})}})}Yt=!0}}function an(e){ge&&(Qt=tn,tn=Math.max(i.getElementById("first-pane").clientHeight-83,0),Qt!==tn&&$("#cw-first-pane-tabmenu-box").css("max-height",tn)),ke&&(en=nn,nn=Math.max(i.getElementById("second-pane").clientHeight-83,0),en!==nn&&$("#cw-second-pane-tabmenu-box").css("max-height",nn)),e||Vt()}function on(e){ce&&fe&&a.setTimeout(function(){ge&&st(F,pe,we),ke&&st(N,Ie,Ee)},1),e||Vt()}function rn(e){g.on("currentFileChange",function(){Te&&(Ut(),on())}),g.on("workingSetSort workingSetMove",function(){Ut(),on()}),g.on("workingSetAdd workingSetAddList workingSetRemove workingSetRemoveList workingSetUpdate workingSetSort workingSetMove",Ut),$(a).on("triggerForCustomWork",Ut),$(a).on("CustomWorkScroll",Vt),p.on("dirtyFlagChange",function(){Ut(),on()}),p.on("fileNameChange",function(e,t,n){var i=s.hashCode(t.replace(/\W/g,"")),o=s.hashCode(n.replace(/\W/g,"")),r=JSON.parse(a.localStorage.getItem(Y));if(r&&r.hasOwnProperty(i)){r[o]=r[i],r[o][0]=n;var l=n.lastIndexOf("/");r[o][1]=n.substr(l+1),delete r[i]}a.localStorage.setItem(Y,JSON.stringify(r))}),g.on("paneLayoutChange",function(e,t){"HORIZONTAL"===t?($("#cw-"+F+"-move-list").html(te[0]),$("#cw-"+N+"-move-list").html(te[1])):"VERTICAL"===t?($("#cw-"+F+"-move-list").html(te[2]),$("#cw-"+N+"-move-list").html(te[3])):$("#cw-"+F+"-move-list").html(te[0])});var t=null;w.on("workspaceUpdateLayout",function(){null!=t&&clearTimeout(t),t=setTimeout(function(){an(!0),on(),qt()},501)}),$("#first-pane").on("panelResizeEnd",function(){an(),qt()}),_.on("panelResizeEnd",an),T.definePreference(G.CWah,"boolean",!1,{description:r.CWAH}),k.isVisible()||L.addClass("cw-sidebar"),T.definePreference(G.CWss,"number",50,{description:r.CWSS}).on("change",function(){de=T.get(G.CWss),"number"!=typeof de&&(de=~~T.get(G.CWss)),de||(de=50,Ue(G.CWss,50))}),T.definePreference(G.CWt,"boolean",!1,{description:r.CWT}).on("change",function(){T.get(G.CWt)?ie||($(i.body).append(e),Me=i.getElementById("cw-tabbar-tooltip"),ie=!0,Me.onmouseover=function(){re||(Me.style.display="block")},Me.onmouseout=function(){re||(Me.style.display="none")}):ie&&(Me.remove(),Me=void 0,ie=!1)})}function sn(){var e=g.getActivePaneId(),t=$("#cw-"+e+"-listview"),n=$("#cw-"+e+"-tabmenu"),a=$("#cw-"+e+"-tabmenu-ul");Pt(e,n,t,a)}function ln(e,t,n,i,o){var r=e?"sessionStorage":"localStorage",l=s.hashCode(n.replace(/\W/g,"")),c=JSON.parse(a[r].getItem(Y))||{};if(c[l]||(c[l]=[n,i]),t)c[l].push(o);else{var f=c[l].indexOf(o);f>-1&&c[l].splice(f,1)}a[r].setItem(Y,JSON.stringify(c))}function cn(e,t,n,i){var o=e?"sessionStorage":"localStorage",r=s.hashCode(t.replace(/\W/g,"")),l=JSON.parse(a[o].getItem(Y))||{},c=[t,n].concat(i);l[r]=c,a[o].setItem(Y,JSON.stringify(l)),c=void 0}function fn(e,t,n,a){return $(i.createElement("div")).attr({"class":"cw-tickmark cwt-"+a,"data-top":t,"data-line":a}).css("top",n+"px").on("click",function(){e.setCursorPos($(this).data("line"),0)})}function dn(e,t,n,i){var o=i?"sessionStorage":"localStorage",r=JSON.parse(a[o].getItem(Y));if(r){var l=n[0].className.indexOf("cwb-current");if(-1===l){var c=e.getFile().fullPath,f=s.hashCode(c.replace(/\W/g,"")),d=r[f];if(d&&void 0!==d[2]){n.addClass("cwb-current");var w,u=e.totalHeight(),g=n[0].clientHeight,p=d.length;for(w=2;p>w;w+=1){var m=t.getLineHandle(d[w]);if(m){t.addLineClass(d[w],"wrap","cw-bookmark");var h=t.charCoords({line:d[w],ch:0},"local").top,v=~~(h/u*g);$(".cwb-bar",n).append(fn(e,h,v,d[w]))}}}}}}function un(e,t,n){var i=n?"sessionStorage":"localStorage",o=JSON.parse(a[i].getItem(Y));if(o){var r=e.getFile().fullPath,l=s.hashCode(r.replace(/\W/g,"")),c=o[l];if(c&&void 0!==c[2]){var d,f=c.length;for(d=2;f>d;d+=1){var u=t.getLineHandle(c[d]);u&&t.addLineClass(c[d],"wrap","cw-bookmark")}}}}function gn(e,t,n,i,o,r){var l,c,d,s=$(".cwb-bar",n),f=0,u=e.getFile(),g=u.fullPath,p=u.name,w=[];s.empty(),d||(d=a.setTimeout(function(){for(d=void 0,c=0;r>c;c+=1){l=e._codeMirror.lineInfo(c);var a=l.wrapClass;if(a&&a.indexOf("cw-bookmark")>-1){f+=1;var u=l.line,m=e.totalHeight(),h=n[0].clientHeight,v=t.charCoords({line:u,ch:0},"local").top,C=~~(v/m*h);s.append(fn(e,v,C,u)),w.push(u)}if(o===f)break;r!==c+1||f||un(e,t,i)}f>0&&(cn(i,g,p,w),w=void 0)}))}function wn(e,t,n,a){var i=$(".cwb-bar",n);t.on("gutterClick",function(t,o,r,s){pn||(pn=setTimeout(function(){if(pn=void 0,"CodeMirror-linenumbers"===r){var l=o||0,c=t.lineInfo(l),f=e.getFile(),d=f.fullPath,u=f.name,g=parseInt(n.css("height"),10),p=e.totalHeight();if(c.wrapClass&&-1!==c.wrapClass.indexOf("cw-bookmark"))t.removeLineClass(l,"wrap","cw-bookmark"),$(".cwt-"+l,n).remove(),ln(a,!1,d,u,l);else{t.addLineClass(l,"wrap","cw-bookmark");var w=s.offsetY,m=~~(w/p*g);i.append(fn(e,w,m,l)),ln(a,!0,d,u,l)}}},8))})}function mn(e){var t=$(i.createElement("textarea"));t.val(e),t.prependTo("body"),t.select(),i.execCommand("copy"),t.remove()}function hn(e){return e.replace(/^\s*$[\n\r]{1,}/gm,"")}function vn(){var e=u.getCurrentFullEditor();if(e){var a,t=p.getCurrentDocument(),n=!1,i=e.getSelectedText();i.length>0?(n=!0,a=i):a=t.getText();var o=e.getSelection();t.batchOperation(function(){n?t.replaceRange(hn(a),o.start,o.end):t.setText(hn(a))})}}function Cn(){var e=u.getActiveEditor().getFile().fullPath;mn(e)}function bn(){var e=c.getSelectedItem();if(e){var t=c.getSelectedItem().fullPath;mn(t)}else mn(c.getInitialProjectPath())}function Mn(){En||(En=a.setTimeout(function(){En=void 0;var e=$(".cw-tickmark",$n),t=e.length;t&&(In=kn,kn=Pn.lineCount(),(kn>In||In>kn)&&gn(Pn,Sn,$n,Wn,t,kn))},15))}function Tn(e,t){P.addMenuDivider(I.FIRST),h.register(V,B,vn),P.addMenuItem(B,"",I.FIRST),h.register(R,H,Cn),P.addMenuItem(H,"",I.FIRST),S.addMenuItem(H,"",I.FIRST),y.addMenuItem(H,"",I.FIRST),h.register(R,j,bn),W.addMenuItem(j,"",I.FIRST),u.on("activeEditorChange",function(e,t,n){if(Pn=t,t&&(X&&(delete sessionStorage[Y],kn=t.lineCount()),yn=t.document,X)){$n=$(t.getRootElement()),Sn=t._codeMirror,Wn=yn.isUntitled();var a=$(i.createElement("div")).attr({"class":"cwb-bar"});$(".cwb-bar",$n).length||$n.append(a),dn(t,Sn,$n,Wn),wn(t,Sn,$n,Wn),yn.on("change",Mn)}}),h.register("custom-work-for-brackets-listview",K,sn),d.addBinding(K,"Ctrl-Shift-V","all");var n=a.setTimeout(function(){var i;i=170>Q?Mustache:brackets.getModule("thirdparty/mustache/mustache"),ee=i.render(e,r),q||(Tt(Z,t),ae(!0)),t>parseInt(q,10)&&(Tt(Z,t),ae()),localStorage.getItem("cw-version-in-localStorage")&&localStorage.removeItem("cw-version-in-localStorage"),a.clearTimeout(n)},1e3);h.register(z,J,ae),E.addMenuItem(J,"",I.AFTER,"navigate.gotoFirstProblem"),E.addMenuDivider(I.AFTER,"navigate.gotoFirstProblem")}var x,ee,ae,de,ue,pe,we,me,he,ve,Ce,be,Ie,Ee,$e,Pe,Se,We,ye,Me,xe,Fe,Ne,De,Ae,Re,Be,ze,Gt,pn,kn,In,En,$n,Pn,Sn,Wn,yn,a=window,i=a.document,o=brackets.getModule("strings"),r=require("i18n!nls/strings"),s=brackets.getModule("utils/StringUtils"),l=brackets.getModule("project/WorkingSetView"),c=brackets.getModule("project/ProjectManager"),f=brackets.getModule("project/FileTreeView"),d=brackets.getModule("command/KeyBindingManager"),u=brackets.getModule("editor/EditorManager"),g=brackets.getModule("view/MainViewManager"),p=brackets.getModule("document/DocumentManager"),w=brackets.getModule("view/WorkspaceManager"),m=brackets.getModule("command/Commands"),h=brackets.getModule("command/CommandManager"),v=brackets.getModule("language/LanguageManager"),C=brackets.getModule("project/FileViewController"),b=brackets.getModule("file/FileUtils"),k=brackets.getModule("project/SidebarView"),I=brackets.getModule("command/Menus"),E=I.getMenu(I.AppMenuBar.NAVIGATE_MENU),P=I.getContextMenu(I.ContextMenuIds.EDITOR_MENU),S=I.getContextMenu(I.ContextMenuIds.INLINE_EDITOR_MENU),W=I.getContextMenu(I.ContextMenuIds.PROJECT_MENU),y=I.getContextMenu(I.ContextMenuIds.WORKING_SET_CONTEXT_MENU),M=brackets.getModule("preferences/PreferencesManager"),T=M.getExtensionPrefs("custom.work"),L=$(".content"),_=$("#sidebar"),O=$(".main-view"),F="first-pane",N="second-pane",D="file",A="index",R="Copy Path",H="custom.work.copypatheditor",V="Remove empty lines",B="custom.work.removeemptylines",z="Custom Work Settings...",J="custom.work.preferences",j="custom.work.copypathproject",G={CWui:"useIconsOfCustomWork",CWgs:"grayScaleIcons",CWbs:"blueish",CWmt:"moveToolbarToSidebar",CWgb:"gutter.bookmark",CWro:"reduce.opacity",CWsb:"splitButton",CWah:"autoHideTheTabmenu",CWt:"tooltip",CWs:"scrollwheel",CWss:"scrollwheel.step",CWsc:"scrollwheel.change",CWwl:"showWorkingListViewonLeftSidebar"},U={checkbox:"checked",number:"value"},X=!1,K="customworkKeyIdListView",Y="custom.work.bookmarks",Z="custom.work.addon.version",q=localStorage.getItem(Z),Q=~~brackets.metadata.apiVersion.replace(/\D+/g,""),te=["&dArr;","&uArr;","&rAarr;","&lArr;","&hArr;"],ne={"all-panes":["cw-flipview-icon-none"],"first-pane":["cw-flipview-icon-bottom","cw-flipview-icon-right"],"second-pane":["cw-flipview-icon-top","cw-flipview-icon-left"]},ie=!1,oe=0,re=!1,se=!1,le=!1,ce=!1,fe=!1,ge=!1,ke=!1,Te=!0,Le=!0,_e=!1,Oe=!1,He=!1,Ve=!1,Je=$(i.createElement("li")).addClass("cw-height cw-dragged-index cw-sortable-placeholder"),je=$(i.createElement("li")).addClass("cw-height cw-li-zero"),Ht=null,jt=!0,Xt=0,Kt=0,Yt=!1,Zt=!1,Qt=0,en=0,tn=0,nn=0;ae=function(e){var t=brackets.getModule("widgets/Dialogs"),n=t.showModalDialogUsingTemplate(ee,!1),a=n.getElement();e||Nt(a,!0),a.find("#CWs").on("change",function(){var e=$(this).is(":checked");a.find("#CWss").parent().parent()[e?"removeClass":"addClass"]("cw-disabled"),a.find("#CWsc").parent().parent()[e?"removeClass":"addClass"]("cw-disabled")}),a.find("#CWui").on("change",function(){var e=$(this).is(":checked");a.find("#CWgs").parent().parent()[e?"removeClass":"addClass"]("cw-disabled")});var i=X,o=i;a.find("#CWgb").on("change",function(){o=$(this).is(":checked")}),a.on("click",".cwdismisspopup",function(){if("dontsave"===$(this).data("button-id"))return void n.close();if(Nt(a),T.save(),Dt(),yn&&yn.on("change",Mn),n.close(),i!=o){var e=t.showModalDialog("cw-reloaddialog",r.NAME_EXTENSION+' <i style="font-size:15px;">(Create bookmark when clicking on the gutter)</i>',r.DIALOG_RELOAD,[{className:t.DIALOG_BTN_CLASS_PRIMARY,id:t.DIALOG_BTN_OK,text:"reload now"},{className:t.DIALOG_BTN_CLASS_LEFT,id:t.DIALOG_BTN_CANCEL,text:"reload later"}]),s=10,l=setInterval(function(){s-=1,$(".cw-reloaddialog").find('[data-button-id="ok"]').text("reload now ("+s+")"),s||$(".cw-reloaddialog").find('[data-button-id="ok"]').click()},1e3);e.done(function(e){clearInterval(l),"ok"===e&&h.execute(m.APP_RELOAD)})}})},n.exports={html:Bt,extension:rn,ready:Tn}});